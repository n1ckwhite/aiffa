#  Этап 39 — Что делает атрибут defer?

**Атрибут `defer`** — это способ управления загрузкой JavaScript-файлов, который сочетает в себе **асинхронную загрузку** с **гарантированным порядком выполнения**. В отличие от `async`, скрипты с `defer` выполняются только после полной загрузки HTML-документа.

---

##  Принцип работы defer

###  **Без атрибута defer:**

```html
<script src="app.js"></script>
```

**Последовательность событий:**
1. Браузер находит `<script>`
2. **Останавливает парсинг HTML** ⏸
3. Загружает `app.js` (блокирует)
4. Выполняет код из `app.js`
5. **Возвращается к парсингу HTML** ▶

###  **С атрибутом defer:**

```html
<script defer src="app.js"></script>
```

**Последовательность событий:**
1. Браузер находит `<script defer>`
2. **Продолжает парсить HTML** (не блокирует) 
3. Загружает `app.js` **параллельно** 
4. **Ждет завершения парсинга HTML** ⏳
5. Выполняет скрипт **в правильном порядке** 

---

##  Ключевые особенности defer

###  **Преимущества:**

*  **Не блокирует рендеринг** — страница отображается быстро
*  **Загружается параллельно** — эффективное использование сети
*  **Гарантированный порядок** — скрипты выполняются в последовательности
*  **Выполняется после DOM** — безопасная работа с элементами страницы

###  **Особенности:**

* ⏳ **Отложенное выполнение** — ждет завершения парсинга HTML
*  **Строгий порядок** — все defer-скрипты выполняются по порядку
*  **Идеален для DOM** — гарантированно выполняется после загрузки элементов

---

##  Сравнение defer vs async

###  **Визуальное сравнение:**

| Характеристика | `defer` | `async` |
|----------------|---------|---------|
| **Блокировка рендеринга** |  Не блокирует |  Не блокирует |
| **Загрузка** |  Параллельно |  Параллельно |
| **Порядок выполнения** |  Гарантирован |  Не гарантирован |
| **Время выполнения** | ⏳ После HTML |  Сразу после загрузки |
| **Безопасность DOM** |  Гарантирована |  Не гарантирована |
| **Применение** |  Основной код |  Независимые скрипты |

###  **Временная диаграмма:**

```
Без атрибутов:
HTML ────⏸─── Script ────▶─── HTML ────⏸─── Script ────▶─── HTML

С async:
HTML ─────── HTML ─────── HTML
Script ────── (выполняется сразу)

С defer:
HTML ───────────── HTML (завершен)
Script ────── (выполняется после HTML)
```

---

##  Практические примеры

###  **Пример 1: Основной код приложения**

```html
<!DOCTYPE html>
<html>
<head>
  <title>Мое приложение</title>
  
  <!-- Библиотеки - defer (зависимые) -->
  <script defer src="jquery.js"></script>
  <script defer src="bootstrap.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <h1>Мое приложение</h1>
  <button id="myButton">Нажми меня</button>
  
  <!-- DOM готов, скрипты выполняются в порядке -->
</body>
</html>
```

**Результат:** Всегда выполнится в порядке: `jquery.js` → `bootstrap.js` → `app.js`

###  **Пример 2: Смешанное использование**

```html
<!DOCTYPE html>
<html>
<head>
  <title>Оптимизированный сайт</title>
  
  <!-- Аналитика - async (независимый) -->
  <script async src="analytics.js"></script>
  
  <!-- Основной код - defer (зависимый) -->
  <script defer src="jquery.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <h1>Оптимизированный сайт</h1>
  <p>Аналитика загружается параллельно, основной код - в правильном порядке.</p>
</body>
</html>
```

**Результат:**
- `analytics.js` — выполнится когда загрузится (независимо)
- `jquery.js` → `app.js` — выполнится в правильном порядке после HTML

---

##  Когда использовать defer

###  ** Идеально подходит для:**

* **Основной логики приложения** — код, который должен работать с DOM
* **Библиотек с зависимостями** — jQuery, Bootstrap, React
* **Скриптов, требующих порядка** — когда один скрипт зависит от другого
* **Кода, работающего с элементами страницы** — обработчики событий, манипуляции с DOM

###  ** НЕ подходит для:**

* **Аналитики** — должна загружаться как можно быстрее
* **Виджетов** — независимые скрипты
* **Критически важных скриптов** — которые должны выполниться до рендеринга

---

##  Отладка defer-скриптов

###  **Проблема: Скрипт выполняется до загрузки DOM**

```javascript
//  Плохо: может выполниться до загрузки элемента
document.getElementById('myButton').addEventListener('click', function() {
  console.log('Клик!');
});
```

**Решение с defer:**
```html
<!--  Хорошо: defer гарантирует выполнение после DOM -->
<script defer src="app.js"></script>
```

```javascript
// app.js - выполнится после загрузки DOM
document.getElementById('myButton').addEventListener('click', function() {
  console.log('Клик!');
});
```

###  **Проблема: Неправильный порядок зависимостей**

```html
<!--  Плохо: непредсказуемый порядок с async -->
<script async src="jquery.js"></script>
<script async src="bootstrap.js"></script>
<script async src="app.js"></script>
```

**Решение:**
```html
<!--  Хорошо: defer гарантирует правильный порядок -->
<script defer src="jquery.js"></script>
<script defer src="bootstrap.js"></script>
<script defer src="app.js"></script>
```

---

##  Сравнение производительности

###  **Тестовая страница:**

```html
<!DOCTYPE html>
<html>
<head>
  <title>Тест производительности</title>
  
  <!-- Вариант 1: Без атрибутов -->
  <!-- <script src="script1.js"></script> -->
  <!-- <script src="script2.js"></script> -->
  
  <!-- Вариант 2: С async -->
  <!-- <script async src="script1.js"></script> -->
  <!-- <script async src="script2.js"></script> -->
  
  <!-- Вариант 3: С defer -->
  <script defer src="script1.js"></script>
  <script defer src="script2.js"></script>
</head>
<body>
  <h1>Тест производительности</h1>
  <p>Время загрузки: <span id="load-time"></span></p>
</body>
</html>
```

**Результаты:**
- **Без атрибутов:** Медленная загрузка, блокировка рендеринга
- **С async:** Быстрая загрузка, непредсказуемый порядок
- **С defer:** Быстрая загрузка, правильный порядок

---

##  Итог

**Атрибут `defer`** — оптимальный выбор для **основного кода приложения**:

*  **Ускоряет загрузку страницы** (не блокирует рендеринг)
*  **Гарантирует правильный порядок** выполнения скриптов
*  **Безопасная работа с DOM** (выполняется после загрузки HTML)
*  **Идеален для зависимых скриптов** (библиотеки, основной код)

**Правило выбора:**
- **`defer`** — для основного кода с зависимостями
- **`async`** — для независимых скриптов (аналитика, виджеты)
- **Без атрибутов** — только для критически важных скриптов

---