#  Как ведут себя `sessionStorage`, `localStorage` и `cookies` при **кросс-доменных запросах (CORS)**

Когда вы отправляете запрос с одного сайта (домен A) на другой сайт (домен B), это считается **кросс-доменным запросом**. В таких ситуациях важно понимать, **какие данные браузер автоматически добавляет к запросу**, а какие — нет.

Рассмотрим, как это работает для каждого механизма хранения данных:

---

###  `sessionStorage`

* **Что это**: Временное хранилище, привязанное к конкретной вкладке браузера. Когда вы закрываете вкладку — данные исчезают.
* **Доступность**: Данные доступны **только в рамках одного origin** (протокол + домен + порт). Даже если у вас две вкладки с одним и тем же сайтом — у них будет разное `sessionStorage`.
* **При кросс-доменных запросах**:
  `sessionStorage` **не участвует в запросе**. То есть, если вы отправляете `fetch()` или `XMLHttpRequest` на другой домен, данные из `sessionStorage` не будут прикреплены автоматически, и другой сайт не сможет получить к ним доступ.

  *Безопасно, но нельзя использовать для передачи данных между доменами.*

---

###  `localStorage`

* **Что это**: Постоянное хранилище, данные в котором сохраняются даже после закрытия браузера.
* **Доступность**: Как и `sessionStorage`, `localStorage` работает **только в пределах одного origin**. Другие сайты — даже поддомены — **не могут его прочитать**.
* **При кросс-доменных запросах**:
  `localStorage` также **не прикрепляется** к запросу. Он существует только в браузере пользователя и доступен JavaScript-кодом с того же сайта.

 *Удобно для хранения настроек и информации пользователя, но не подходит для обмена между сайтами.*

---

###  `cookies`

* **Что это**: Маленькие текстовые данные, которые браузер может автоматически отправлять с каждым HTTP-запросом к серверу.
* **Доступность**:

    * Могут быть доступны не только текущему домену, но и **поддоменам**, если задать `Domain=example.com`.
* **При кросс-доменных запросах**:

    * По умолчанию браузеры **не отправляют cookies** с кросс-доменными запросами из-за политики безопасности.
    * Но если:

        * Вы установили cookie с флагами `SameSite=None; Secure` (обязательно, если HTTPS),
        * И ваш JavaScript-запрос использует `credentials: 'include'` (в `fetch`),

      то **такие cookies будут автоматически прикреплены** к запросу.

 *Cookies — **единственный** способ, как браузер может автоматически передавать данные между доменами (например, для авторизации).*

---

#### Пример: fetch с передачей cookies

```js
fetch("https://api.example.com/data", {
  method: "GET",
  credentials: "include", // это обязательно
});
```

Если cookie установлены с `SameSite=None; Secure`, браузер отправит их с этим запросом.

---

##  Итог

| Механизм         | Доступ между доменами | Передаётся при CORS-запросах | Особенности                                |
| ---------------- | --------------------- | ---------------------------- | ------------------------------------------ |
| `sessionStorage` |  Нет                 |  Нет                        | Только в рамках одной вкладки и origin     |
| `localStorage`   |  Нет                 |  Нет                        | Только для origin, остаётся между сессиями |
| `cookies`        |  Да (если настроено) |  Да (если настроено)        | Используются для авторизации и сессий      |

---

### Если нужно делиться данными между доменами:

* Используйте `cookies` с правильными флагами.
* Или обменивайтесь данными через сервер (API).
* Или используйте `postMessage` для общения между iframe/окнами с разных доменов.

##  ЗАДАЧИ

Вот несколько задач, которые помогут вам закрепить понимание `sessionStorage, localStorage и cookies в контексте кросс-доменных запросов`:

---

###  Задача 1: Кто что видит?

 На сайте `https://site-a.com` в `localStorage` сохранены данные:

```js
localStorage.setItem('theme', 'dark');
```

Теперь вы открываете iframe с сайтом `https://site-b.com` внутри `site-a.com`.
Может ли JavaScript внутри `site-b.com` получить значение `theme` из `localStorage`?

<details>
<summary> Ответ</summary>

Нет. `localStorage` изолирован по origin (протокол + домен + порт). `site-b.com` не имеет доступа к `localStorage` сайта `site-a.com`.

</details>

---

###  Задача 2: Cookie в кросс-доменном запросе

 Сайт `https://app.client.com` делает `fetch`-запрос на `https://api.server.com/data`.

На домене `api.server.com` уже установлены cookies с флагами:

```
Set-Cookie: session_id=abc123; SameSite=None; Secure
```

Что нужно добавить в `fetch`, чтобы cookie отправились вместе с запросом?

<details>
<summary> Ответ</summary>

Нужно указать опцию `credentials: 'include'`:

```js
fetch('https://api.server.com/data', {
  method: 'GET',
  credentials: 'include'
});
```

Без этого cookies не будут отправлены.

</details>

---

###  Задача 3: Какой тип хранения?

 Вы разрабатываете виджет, который встраивается через `<iframe>` на сторонние сайты. В нем нужно хранить уникальный ID пользователя.
Этот ID должен:

* Храниться между сессиями
* Быть доступен только внутри самого виджета
* Не утекать на другие сайты

Какой способ хранения вы выберете?

<details>
<summary> Ответ</summary>

Подходит `localStorage`. Он сохраняется между сессиями, и доступен только скриптам, запущенным в том же origin (в данном случае — в iframe виджета).

</details>

---

###  Задача 4: sessionStorage и вкладки

 Сайт `https://shop.example.com` в `sessionStorage` сохраняет корзину товаров.
Пользователь открывает этот сайт во второй вкладке. Будет ли в ней та же корзина?

<details>
<summary> Ответ</summary>

Нет. `sessionStorage` уникален для каждой вкладки. Во второй вкладке корзина будет пустой.

</details>

---

 Эти знания помогают правильно выбирать способ хранения и понимать, какие данные доступны и передаются при междоменном взаимодействии.

---